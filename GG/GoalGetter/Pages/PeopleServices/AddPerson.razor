@inject IAddPersonUseCase AddPersonUseCase
@inject ISnackbar Snackbar
@using Libraries.DistanceAddressCalculator;
@using System.Timers;




<EditForm Model="newPerson" OnValidSubmit="SavePerson">
	<DataAnnotationsValidator />
	<MudItem>
		<MudCard>
			<MudCardContent>
				<MudTextField Label="First name" HelperText="Max. 8 characters"
								@bind-Value="newPerson.Firstname" For="@(() => newPerson.Firstname)" />
				<MudTextField Label="Last name" Class="mt-3"
								@bind-Value="newPerson.Lastname" For="@(() => newPerson.Lastname)" />
				<MudTextField Label="Email" Class="mt-3"
								@bind-Value="newPerson.Email" For="@(() => newPerson.Email)" InputType="InputType.Email" />
				<MudTextField Label="Phone number" Class="mt-3"
								@bind-Value="newPerson.Phone" For="@(() => newPerson.Phone)" InputType="InputType.Telephone" />

				<MudAutocomplete T="string" Label="Address" @bind-Value="addressval" SearchFunc="@SearchAddress"
									ResetValueOnEmptyText="@resetValueOnEmptyText"
									CoerceText="@coerceText" CoerceValue="@coerceValue"
									AdornmentIcon="@Icons.Material.Filled.Map" AdornmentColor="Color.Primary" />

									<MudText>@API_CALLCOUNT</MudText>


				<MudFileUpload T="IBrowserFile" Accept=".jpg, .png" FilesChanged="UploadFiles">
					<ButtonTemplate Context="pictureUploadContext">
						<MudIconButton HtmlTag="label"
									   Color="Color.Info"
									   Icon="@Icons.Material.Filled.PhotoCamera"
										for="@pictureUploadContext">
						</MudIconButton>
					</ButtonTemplate>
				</MudFileUpload>

				@if (files.Any())
				{
					<MudText>@files.Last().Name</MudText>
				}

			</MudCardContent>
			<MudCardActions>
				<MudButton ButtonType="ButtonType.Submit" class="btn btn-primary">Save</MudButton>
				<MudButton ButtonType="ButtonType.Button" class="btn btn-primary" @onclick="Cancel">Cancel</MudButton>
			</MudCardActions>
		</MudCard>
	</MudItem>
</EditForm>

@code {

	private Person newPerson = new Person();
	[CascadingParameter] MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public EventCallback<bool> Windowclosed { get; set; }

	private async Task SavePerson()
	{
		StatusReport<EmptyVal> status = await AddPersonUseCase.ExecuteAsync(newPerson);
		Snackbar.Add(status.Reason, status.severity);

		MudDialog.Close(DialogResult.Ok(true));
	}

	void Cancel() => MudDialog.Cancel();

	//Avatar Upload
	IList<IBrowserFile> files = new List<IBrowserFile>();
	private void UploadFiles(IBrowserFile file)
	{
		files.Add(file);
		//TODO upload the files to the server
	}

	//Location 
	private bool resetValueOnEmptyText;
	private bool coerceText;
	private bool coerceValue;
	private string addressval;
	private int API_CALLCOUNT = 0;
	private int TimeBetweenAPICall = 1000;
	private Timer searchTimer;

	private Address[] searchOptions =
	{
	};

	private async Task<IEnumerable<string>> SearchAddress(string value)
	{
		// In real life, use an asynchronous function for fetching data from an API.
		await Task.Delay(5);

		if (value == null)
			return new List<string>();

		// If the text is null or empty, don't return values (drop-down will not open).
		addressval = value;
		if(value.Length > 4)
			await TimerTask();
		return searchOptions.Select(x => $"OSM: {x.ID} {x.Name}");
	}

	private string latestSearch = "";
	private async Task UpdateAddresses()
	{
		latestSearch = addressval;
		searchOptions = Address.FindAddresses(addressval);
		API_CALLCOUNT++;
	}

	private int tmp = 0;
	private async Task TimerTask()
	{
		tmp++;
		int runtime = tmp;
		await Task.Delay(TimeBetweenAPICall);
		if(runtime == tmp)
			UpdateAddresses();
	}

}
